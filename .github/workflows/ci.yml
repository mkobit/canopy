name: CI

on:
  push:
    paths-ignore:
      - 'docs/design/**'
  pull_request:
    paths-ignore:
      - 'docs/design/**'

jobs:
  build:
    name: Build, lint, and test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      max-parallel: 1
      matrix:
        os: [ubuntu-24.04, macos-14]
        bun-version: [1.2.14]

    steps:
      - name: Checkout repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Install dependencies
        id: install
        run: bun install

      - name: Lint
        if: "!cancelled() && steps.install.outcome == 'success'"
        run: bun run lint

      - name: Typecheck
        if: "!cancelled() && steps.install.outcome == 'success'"
        run: bun run typecheck

      - name: Build
        if: "!cancelled() && steps.install.outcome == 'success'"
        run: bun run build

      - name: Test
        if: "!cancelled() && steps.install.outcome == 'success'"
        run: bun run test -- run --coverage

      - name: Upload coverage
        if: "!cancelled() && steps.install.outcome == 'success'"
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v3
